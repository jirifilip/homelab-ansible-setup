- name: List VMs
  community.libvirt.virt:
    command: list_vms
  register: listed_vms

- name: Destroy VMs
  community.libvirt.virt:
    command: destroy
    name: "{{ item }}"
  failed_when: false
  with_items: "{{ listed_vms.list_vms }}"

- name: Undefine VMs
  community.libvirt.virt:
    command: undefine
    name: "{{ item }}"
  with_items: "{{ listed_vms.list_vms }}"

- name: Remove disks
  ansible.builtin.file:
    name: "{{ base_path_images }}/{{ item }}.qcow2"
    state: absent
  with_items: "{{ listed_vms.list_vms }}"
