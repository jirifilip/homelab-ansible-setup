- name: Get PCI devices
  ansible.builtin.command:
    cmd: lspci -nn
  register: lspci_output

- name: Find GPU devices
  ansible.builtin.set_fact:
    vfio_gpu_ids: >-
      {{
        lspci_output.stdout_lines
        | select("search", "VGA compatible controller")
        | reject("search", "Intel Corporation")
        | map("regex_search", "^[0-9a-f:.]+")
        | list
      }}

- name: Get IOMMU group devices
  ansible.builtin.command:
    ls /sys/bus/pci/devices/0000:{{ item }}/iommu_group/devices
  register: iommu_output
  loop: "{{ vfio_gpu_ids }}"

- name: Set IOMMU groups
  ansible.builtin.set_fact:
    iommu_groups: >-
      {{
        iommu_output.results
        | map(attribute="stdout_lines")
        | flatten
        | unique
      }}

- name: Extract PCI IDs
  ansible.builtin.command:
    cmd: "lspci -nns {{ item }}"
  loop: "{{ iommu_groups }}"
  register: pci_ids_output

- name: Set PCI IDs
  ansible.builtin.set_fact:
    pci_ids: >- 
      {{
        pci_ids_output.results
        | map(attribute="stdout_lines")
        | flatten
        | map("regex_search", "[0-9a-fA-F]{4}:[0-9a-fA-F]{4}")
        | list
      }}
    
- name: Configure GPU virtualization
  ansible.builtin.copy:
    dest: /etc/modprobe.d/vfio.conf
    content: |
      options vfio-pci ids={{ pci_ids | join(",") }}

- name: Blacklist nouveau driver
  ansible.builtin.copy:
    dest: /etc/modprobe.d/blacklist-nouveau.conf
    content: |
      blacklist nouveau
      options nouveau modeset=0
  notify: rebuilt_initramfs

- name: Put vfio drivers on initramfs
  ansible.builtin.copy:
    dest: /etc/dracut.conf.d/vfio.conf
    content: |
      add_drivers+=" vfio vfio_iommu_type1 vfio_pci "
  notify: rebuilt_initramfs

- name: Enable IOMMU in GRUB
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: "^GRUB_CMDLINE_LINUX="
    line: 'GRUB_CMDLINE_LINUX="rd.lvm.lv=fedora/root rhgb quiet intel_iommu=on iommu=pt rd.driver.pre=vfio-pci"'
  notify: update_grub

- name: Save Device IDs for running with KVM
  delegate_to: localhost
  ansible.builtin.copy:
    dest: ./inventory/group_vars/all/gpu.yaml
    content: |
      gpu_devices: {{
        pci_ids_output.results
        | map(attribute="stdout_lines")
        | flatten
        | map("regex_search", "^[0-9a-f:.]+")
        | list
        | to_yaml
        | indent(2)
        | trim
      }}
