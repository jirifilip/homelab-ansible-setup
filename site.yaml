- name: Setup Homelab
  hosts: homelab
  become: true
  roles:
    - role: install_common
    - role: install_packer
    - role: convert_to_server
    - role: setup_vm_networking
    - role: virtualize_gpu
  tags:
    - install

- name: Start VMs
  become: true
  hosts: homelab
  roles:
    - role: create_vm
      vm_name: control-plane-1
      vcpus: 3
      memory_mb: 4096
      disk_size: 10G
      network_interface: bridge

    - role: create_vm
      vm_name: worker-1
      vcpus: 2
      memory_mb: 2048
      disk_size: 10G
      network_interface: bridge

    - role: create_vm
      vm_name: worker-2
      vcpus: 2
      memory_mb: 2048
      disk_size: 10G
      network_interface: bridge

    - role: create_vm
      vm_name: gpu-worker-1
      vcpus: 4
      memory_mb: 4096
      disk_size: 10G
      network_interface: bridge
      use_gpu: true
  tags:
    - create

- name: get VM IPs
  hosts: homelab
  roles:
    - role: get_vm_ip
  tags:
    - ip
    - never

- name: Setup GPU workers
  become: true
  hosts: gpu-workers
  roles:
    - role: nvidia.nvidia_driver
    - role: setup_gpu_containerization
  tags:
    - setup-gpu-workers

- name: Install Kubernetes
  become: true
  hosts: vms
  roles:
    - role: install_kubernetes
  tags:
    - never
    - k8s

- name: Run Kubernetes
  hosts: localhost
  roles:
    - role: run_kubernetes
  tags:
    - never
    - k8s

- name: Destroy all VMs
  hosts: homelab
  roles:
    - role: destroy_vms
  tags:
    - never
    - destroy
